connection node_2;
connection node_1;
connection node_1;
connection node_2;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY) ENGINE=InnoDB;
connect t1, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection t1;
XA START 't1';
INSERT INTO t1 VALUES (1);
XA END 't1';
XA PREPARE 't1';
connect t2, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection t2;
XA START 't2';
INSERT INTO t1 VALUES (2);
XA END 't2';
XA PREPARE 't2';
connect t3, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection t3;
XA START 't3';
INSERT INTO t1 VALUES (3);
XA END 't3';
XA PREPARE 't3';
connection node_1;
SELECT COUNT(*) AS expect_3 FROM mysql.wsrep_streaming_log;
expect_3
3
connection node_2;
SET SESSION wsrep_sync_wait = 0;
SET GLOBAL wsrep_provider_options = 'gmcast.isolate=1';
connection t1;
XA COMMIT 't1';
ERROR HY000: Got error 6 "No such device or address" during COMMIT
connection node_2;
SET GLOBAL wsrep_provider_options = 'gmcast.isolate=0';
connection node_1;
Expect transactions 't1', 't2' and 't3' to be in prepared state
XA RECOVER;
formatID	gtrid_length	bqual_length	data
1	2	0	t1
1	2	0	t3
1	2	0	t2
SELECT COUNT(*) AS expect_3 FROM mysql.wsrep_streaming_log;
expect_3
3
connection node_2;
Expect transactions 't1', 't2' and 't3' to be in prepared state
XA RECOVER;
formatID	gtrid_length	bqual_length	data
1	2	0	t1
1	2	0	t3
1	2	0	t2
SELECT COUNT(*) AS expect_3 FROM mysql.wsrep_streaming_log;
expect_3
3
connection t1;
XA COMMIT 't1';
connection t2;
XA COMMIT 't2';
connection t3;
XA ROLLBACK 't3';
connection node_1;
SELECT * FROM t1;
f1
1
2
XA RECOVER;
formatID	gtrid_length	bqual_length	data
SELECT COUNT(*) AS expect_0 FROM mysql.wsrep_streaming_log;
expect_0
0
call mtr.add_suppression('Quorum: No node with complete state');
connection node_2;
SET SESSION wsrep_sync_wait = DEFAULT;
SELECT * FROM t1;
f1
1
2
XA RECOVER;
formatID	gtrid_length	bqual_length	data
SELECT COUNT(*) AS expect_0 FROM mysql.wsrep_streaming_log;
expect_0
0
DROP TABLE t1;
call mtr.add_suppression('Quorum: No node with complete state');

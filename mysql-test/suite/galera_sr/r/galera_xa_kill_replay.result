connection node_2;
connection node_1;
connection node_1;
connection node_2;
connection node_1;
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=true';
connection node_2;
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=true';
connect conn_restart, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection conn_restart;
SET GLOBAL debug_dbug="d,crash_xa_replay_before_rollback";;
connect trx, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection trx;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY AUTO_INCREMENT, f2 CHAR(255) , KEY(f2)) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1, 'a'), (2, 'b'), (4, 'd'), (5, 'f');
XA START 't';
UPDATE t1 SET f2 = 'x' WHERE f1 < 3;
XA END 't';
XA PREPARE 't';
connection node_1;
DELETE FROM t1 WHERE f1 > 2;
SET SESSION wsrep_sync_wait = 0;
SET SESSION wsrep_sync_wait = DEFAULT;
connection conn_restart;
Performing --wsrep-recover ...
# restart
connection node_2;
XA RECOVER;
formatID	gtrid_length	bqual_length	data
1	1	0	t
XA COMMIT 't';
connection node_1;
DROP TABLE t1;
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=false';
connection node_2;
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=false';
call mtr.add_suppression('Found 1 prepared XA transactions');
call mtr.add_suppression('Discovered discontinuity in recovered wsrep transaction XIDs.');
disconnect trx;
disconnect conn_restart;
connection node_1;
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=true';
connection node_2;
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=true';
connect conn_restart, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection conn_restart;
SET GLOBAL debug_dbug="d,crash_xa_replay_after_rollback";;
connect trx, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection trx;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY AUTO_INCREMENT, f2 CHAR(255) , KEY(f2)) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1, 'a'), (2, 'b'), (4, 'd'), (5, 'f');
XA START 't';
UPDATE t1 SET f2 = 'x' WHERE f1 < 3;
XA END 't';
XA PREPARE 't';
connection node_1;
DELETE FROM t1 WHERE f1 > 2;
SET SESSION wsrep_sync_wait = 0;
SET SESSION wsrep_sync_wait = DEFAULT;
connection conn_restart;
Performing --wsrep-recover ...
# restart
connection node_2;
XA RECOVER;
formatID	gtrid_length	bqual_length	data
1	1	0	t
XA COMMIT 't';
connection node_1;
DROP TABLE t1;
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=false';
connection node_2;
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=false';
call mtr.add_suppression('Found 1 prepared XA transactions');
call mtr.add_suppression('Discovered discontinuity in recovered wsrep transaction XIDs.');
disconnect trx;
disconnect conn_restart;

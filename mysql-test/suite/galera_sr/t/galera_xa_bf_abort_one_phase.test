#
# Test BF abort on XA COMMIT ONE PHASE
#

--source include/galera_cluster.inc
--source include/have_debug_sync.inc

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY, f2 CHAR(64));

--connection node_1
--let $wsrep_local_bf_aborts_before = `SELECT VARIABLE_VALUE FROM INFORMATION_SCHEMA.GLOBAL_STATUS WHERE VARIABLE_NAME = 'wsrep_local_bf_aborts'`
XA START 'test';
INSERT INTO t1 VALUES (1, 'node1');
XA END 'test';
SET DEBUG_SYNC = "wsrep_ha_trans_commit_before_commit_one_phase SIGNAL after_prepare WAIT_FOR continue";
--send XA COMMIT 'test' ONE PHASE;

--connection node_1a
SET DEBUG_SYNC = 'now WAIT_FOR after_prepare';

--connection node_2
INSERT INTO t1 VALUES (1, 'node2');

#
# Wait for 'test' to be BF aborted
#
--connection node_1a
--let $wait_condition = SELECT VARIABLE_VALUE = $wsrep_local_bf_aborts_before + 1 FROM INFORMATION_SCHEMA.GLOBAL_STATUS WHERE VARIABLE_NAME = 'wsrep_local_bf_aborts'
--source include/wait_condition.inc

--connection node_1
--error ER_XA_RBDEADLOCK
--reap

--connection node_1
SELECT * FROM t1;

DROP TABLE t1;
SET DEBUG_SYNC = 'RESET';

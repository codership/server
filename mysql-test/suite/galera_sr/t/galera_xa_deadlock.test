#
# Test native deadlock handling
#

--source include/galera_cluster.inc

CREATE TABLE t1(f1 INTEGER PRIMARY KEY, f2 INTEGER);
INSERT INTO t1 VALUES (1, 1);
INSERT INTO t1 VALUES (2, 2);

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1


--connection node_1a
XA START 'trx_a';
UPDATE t1 set f2 = 10 WHERE f1 = 1;

--connection node_1b
XA START 'trx_b';
UPDATE t1 SET f2 = 20 WHERE f1 = 2;

--connection node_1a
--send UPDATE t1 set f2 = 20 WHERE f1 = 2 /* node 1a */

--connection node_1b
--sleep 1
--error ER_LOCK_DEADLOCK
UPDATE t1 SET f2 = 20 WHERE f1 = 1 /* node_1b */;

SELECT COUNT(*) FROM t1;
INSERT INTO t1 VALUES (10,10);
SELECT COUNT(*) FROM t1;

--error ER_XA_RBDEADLOCK
XA END 'trx_b';
XA ROLLBACK 'trx_b';

--connection node_1a
--reap
XA END 'trx_a';
XA ROLLBACK 'trx_a';

SELECT * FROM t1;

DROP TABLE t1;

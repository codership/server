--source include/galera_cluster.inc

--let $count = 100

CREATE TABLE t1 (f1 INTEGER PRIMARY KEY AUTO_INCREMENT, f2 INTEGER) ENGINE=InnoDB;

--connect trx1, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connect trx2, 127.0.0.1, root, , test, $NODE_MYPORT_2

--disable_query_log
--disable_result_log
while ($count)
{
  --connection trx1
  SET SESSION wsrep_sync_wait = DEFAULT;
  DELETE FROM t1;
  INSERT INTO t1 VALUES (1, 1), (2, 2), (3,3), (4, 4), (5, 5);
  SET SESSION wsrep_sync_wait = 0;
  --connection trx2
  SET SESSION wsrep_sync_wait = DEFAULT;
  SELECT * FROM t1;
  SET SESSION wsrep_sync_wait = 0;

  --connection trx1
  --send_eval XA START 'trx1'; DELETE FROM t1 WHERE f2 < 3; XA END 'trx1'; XA PREPARE 'trx1'; XA COMMIT 'trx1'
  --connection trx2
  --send_eval XA START 'trx2'; UPDATE t1 SET f2 = 6 WHERE f2 > 3; XA END 'trx2'; XA PREPARE 'trx2'; XA COMMIT 'trx2'

  --connection trx1
  --error 0,1213,1062,1399,1614,ER_XAER_NOTA
  --reap

  if ($mysql_errno > 0)
  {
    --error 0, ER_XA_RBDEADLOCK, ER_XAER_RMFAIL, ER_XAER_NOTA
    XA END 'trx2';
    --error 0,ER_XAER_NOTA
    XA ROLLBACK 'trx1';
  }

  --connection trx2
  --error 0,1213,1062,1399,1614,ER_XAER_NOTA
  --reap

  if ($mysql_errno > 0)
  {
    --error 0, ER_XA_RBDEADLOCK, ER_XAER_RMFAIL, ER_XAER_NOTA
    XA END 'trx2';
    --error 0,ER_XAER_NOTA
    XA ROLLBACK 'trx2';
  }

--dec $count
}
--enable_result_log
--enable_query_log

--connection node_1
SELECT COUNT(*) AS expect_0 FROM mysql.wsrep_streaming_log;
XA RECOVER;

--connection node_2
SELECT COUNT(*) AS expect_0 FROM mysql.wsrep_streaming_log;
XA RECOVER;

DROP TABLE t1;

--connection node_1
call mtr.add_suppression("Failed to commit fragment");

--connection node_2
call mtr.add_suppression("Failed to commit fragment");

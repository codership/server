#
# Test XA transactions involving multiple storage engines.
# This test uses innodb and rocksdb engines, both
# are XA capable.
# Notice that Galera does not support replication for rocksdb
# engine, so changes to rocksdb tables are not replication.
#

--source include/galera_cluster.inc
--source ../mariabackup/include/have_rocksdb.inc

--connection node_1
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY) ENGINE = INNODB;
CREATE TABLE t2 (f1 INTEGER PRIMARY KEY) ENGINE = ROCKSDB;


#
# XA COMMIT
#
--connection node_1
XA START 'trx';
INSERT INTO t1 VALUES (1);
INSERT INTO t2 VALUES (1);
XA END 'trx';
XA PREPARE 'trx';
XA COMMIT 'trx';

SELECT * FROM t1;
SELECT * FROM t2;

--connection node_2
SELECT * FROM t1;
SELECT * FROM t2;


#
# XA COMMIT ONE PHASE
#
--connection node_1
XA START 'trx';
INSERT INTO t1 VALUES (2);
INSERT INTO t2 VALUES (2);
XA END 'trx';
XA COMMIT 'trx' ONE PHASE;

SELECT * FROM t1;
SELECT * FROM t2;

--connection node_2
SELECT * FROM t1;
SELECT * FROM t2;


#
# XA ROLLBACK
#
--connection node_1
XA START 'trx';
INSERT INTO t1 VALUES (3);
INSERT INTO t2 VALUES (3);
XA END 'trx';
XA PREPARE 'trx';
XA ROLLBACK 'trx';

SELECT * FROM t1;
SELECT * FROM t2;

--connection node_2
SELECT * FROM t1;
SELECT * FROM t2;


#
# Cleanup
#
DROP TABLE t1;
DROP TABLE t2;

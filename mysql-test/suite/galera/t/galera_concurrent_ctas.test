--source include/galera_cluster.inc
--source include/big_test.inc
--source include/have_debug_sync.inc
--source include/galera_have_debug_sync.inc

--write_file $MYSQLTEST_VARDIR/tmp/galera_concurrent.sql
CREATE table t1 as SELECT SLEEP(0.1);
DROP table t1;
CREATE table t1 as SELECT SLEEP(0.1);
DROP table t1;
CREATE table t1 as SELECT SLEEP(0.1);
DROP table t1;
CREATE table t1 as SELECT SLEEP(0.1);
DROP table t1;
CREATE table t1 as SELECT SLEEP(0.1);
DROP table t1;
CREATE table t1 as SELECT SLEEP(0.1);
DROP table t1;
CREATE table t1 as SELECT SLEEP(0.1);
DROP table t1;
CREATE table t1 as SELECT SLEEP(0.1);
DROP table t1;
CREATE table t1 as SELECT SLEEP(0.2);
CREATE table t2 as SELECT SLEEP(0.2);
CREATE table t3 as SELECT SLEEP(0.2);
CREATE table t4 as SELECT SLEEP(0.2);
CREATE table t5 as SELECT SLEEP(0.2);
CREATE table t6 as SELECT SLEEP(0.2);
CREATE table t7 as SELECT SLEEP(0.2);
CREATE table t8 as SELECT SLEEP(0.2);
CREATE table t9 as SELECT SLEEP(0.2);
DROP table t1;
DROP table t2;
DROP table t3;
DROP table t4;
DROP table t5;
DROP table t6;
DROP table t7;
DROP table t8;
DROP table t9;
EOF

let $run=10;

while($run)
{
  --error 0,1
  exec $MYSQL --user=root --host=127.0.0.1 --port=$NODE_MYPORT_1 test \
         < $MYSQLTEST_VARDIR/tmp/galera_concurrent.sql & \
       $MYSQL --user=root --host=127.0.0.1 --port=$NODE_MYPORT_2 test \
         < $MYSQLTEST_VARDIR/tmp/galera_concurrent.sql;
  dec $run;
}

--remove_file $MYSQLTEST_VARDIR/tmp/galera_concurrent.sql



--echo *****************************************************************
--echo Second test scenario
--echo *****************************************************************

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connection node_1a
SET SESSION wsrep_sync_wait = 0;

# sync point for first transaction
--let $galera_sync_point = apply_monitor_slave_enter_sync
--source include/galera_set_sync_point.inc

--connection node_2
CREATE TABLE t1 as SELECT SLEEP(0.1);

# wait for first transaction to reach sync point
--connection node_1a
--let $galera_sync_point = apply_monitor_slave_enter_sync
--source include/galera_wait_sync_point.inc
--source include/galera_clear_sync_point.inc

--connection node_1
# in 10.4 CTAS will be retried, making sure retrying will not happen now
SET SESSION wsrep_retry_autocommit = 0;
--send CREATE TABLE t1 as SELECT SLEEP(0.2);

--sleep 5

# release first transaction
--connection node_1a
--let $galera_sync_point = apply_monitor_slave_enter_sync
--source include/galera_signal_sync_point.inc
--source include/galera_clear_sync_point.inc

--connection node_1
--error ER_LOCK_DEADLOCK
--reap


DROP TABLE t1;
